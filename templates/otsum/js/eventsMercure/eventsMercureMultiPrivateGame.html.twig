<script>
    //--- EVENTS MERCURE ---//
    // Si l'utilisateur est connectÃ©
    {% if app.user %}
    //--- TOPICS INSCRIPTIONS ---//
    // Url mercure server
    const url = new URL('http://localhost:3000/.well-known/mercure')
    // Topic joining private game
    url.searchParams.append('topic', '/joiningPrivateGame/' + {{ idGame }})
    url.searchParams.append('topic', '/checkPresenceOfAllPlayers/' + {{ idGame }})

    //--- LISTENING FOR MERCURE EVENTS ---//
    const eventSource = new EventSource(url)
    eventSource.onmessage = (e) => {
        // joining private game
        if (JSON.parse(e.data).topic === '/joiningPrivateGame/' + {{ idGame }}) {
            let idPlayer = JSON.parse(e.data).idPlayer;
            let userAvatarBox = $(`[data-idUser='${idPlayer}']`).find('.avatarBox');
            if (userAvatarBox.hasClass('absent')) {
                userAvatarBox.removeClass('absent');
                userAvatarBox.find('.absent').remove();
            }
        }
        // checking the presence of all the players
        if (JSON.parse(e.data).topic === '/checkPresenceOfAllPlayers/' + {{ idGame }}) {
            creationDeLaGrille("{{ firstLetter }}", {{ difficulty }});
        }
    }

    //-- Before unload:  Unsubscribe mercure topics
    window.addEventListener('beforeunload', function () {
        if (eventSource != null) {
            eventSource.close()
        }
    })
    {% endif %}
</script>
