<script>
    //--- EVENTS MERCURE ---//
    // Si l'utilisateur est connecté
    {% if app.user %}
    //--- TOPICS INSCRIPTIONS ---//
    // Url mercure server
    const url = new URL('http://localhost:3000/.well-known/mercure')
    // Topic joining private game
    url.searchParams.append('topic', '/joiningPrivateGame/' + {{ idGame }})
    url.searchParams.append('topic', '/checkPresenceOfAllPlayers/' + {{ idGame }})
    url.searchParams.append('topic', '/startChrono/' + {{ idGame }})
    url.searchParams.append('topic', '/retrieveChrono/' + {{ idGame }})
    url.searchParams.append('topic', '/restartRound/' + {{ idGame }})

    //--- LISTENING FOR MERCURE EVENTS ---//
    const eventSource = new EventSource(url)
    eventSource.onmessage = (e) => {
        // joining private game
        if (JSON.parse(e.data).topic === '/joiningPrivateGame/' + {{ idGame }}) {
            let idPlayer = JSON.parse(e.data).idPlayer;
            let userAvatarBox = $(`[data-idUser='${idPlayer}']`).find('.avatarBox');
            if (userAvatarBox.hasClass('absent')) {
                userAvatarBox.removeClass('absent');
                userAvatarBox.find('.absent').remove();
            }
        }
        // checking the presence of all the players
        if (JSON.parse(e.data).topic === '/checkPresenceOfAllPlayers/' + {{ idGame }}) {
            creationDeLaGrille("{{ firstLetter }}", {{ difficulty }});
        }
        // start chrono
        if (JSON.parse(e.data).topic === '/startChrono/' + {{ idGame }}) {
            simplyCountDownStart(
                JSON.parse(e.data).arrayChrono,
                JSON.parse(e.data).currentPlayer
            );
        }
        // retrieve chrono
        if (JSON.parse(e.data).topic === '/retrieveChrono/' + {{ idGame }}) {
            simplyCountDownStart(
                JSON.parse(e.data).arrayChrono,
                JSON.parse(e.data).currentPlayer
            );
        }
        // restart round
        if (JSON.parse(e.data).topic === '/restartRound/' + {{ idGame }}) {
            displayActualGrid();
            if(JSON.parse(e.data).actualTeam){
                $('.currentTeam').removeClass('currentTeam');
                $('.multiPrivateGame .' + JSON.parse(e.data).actualTeam).addClass('currentTeam');
            }
            if(JSON.parse(e.data).actualPlayer === {{ app.user.id }}){
                console.log("startChrono");
                // Start chrono
                $.ajax({
                    method: "POST",
                    url: "{{ path('startChrono') }}",
                    data: {
                        idGame: {{ idGame }},
                        restart: true
                    }
                })
                .done(function () {
                    // Création du clavier
                    $('#div_keyboard #keyboard').jkeyboard({
                        input: $('#search_field'),
                        layout: 'azerty',
                    });
                    console.log("newKeyboard 2nd");
                });
            } else {
                $('#div_keyboard').empty();
                $('#div_keyboard').append("<div id='keyboard'></div");
            }
        }
    }

    //-- Before unload:  Unsubscribe mercure topics
    window.addEventListener('beforeunload', function () {
        if (eventSource != null) {
            eventSource.close()
        }
    })
    {% endif %}
</script>
