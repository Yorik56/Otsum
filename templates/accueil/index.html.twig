{% extends 'base.html.twig' %}

{% block title %}Otsum{% endblock %}

{% block body %}
    <h1 class="text-center">OTSUM</h1>
    <div class="container d-flex justify-content-center">
        <section class="row area d-flex justify-content-center">
            <div class="block_bouton col-12 ">
                <div class="row">
                    <div class="col">
                        <a class="btn button d-block w-100" href="{{ path('hub') }}">Partie en ligne</a>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <a class="btn button d-block w-100" href="{{ path('hub') }}">Partie locale</a>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <a class="btn button d-block w-100" href="{{ path('classement') }}">Classement</a>
                    </div>
                </div>
            </div>
        </section>
    </div>
    <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" style="position: absolute;top: 0;right: 0">
        <div class="toast-header">
            <strong class="mr-auto">Bootstrap</strong>
            <small>11 mins ago</small>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="toast-body"></div>
    </div>
    <script>
        $(document).ready(function(){
            // Si l'utilisateur est connecté
            {% if app.user %}
                //-- Inscription a un topic mercure.
                // Initialisation de l'Url mercure
                const url = new URL('http://localhost:3000/.well-known/mercure')
                // On ajoute le "topic" correspondant aux notifications de chat
                url.searchParams.append('topic','/accueil')
                // On ajoute le "topic" correspondant aux notifications de l'utilisateur courant
                url.searchParams.append('topic','/accueil/notifications/demande_ajout/' + {{ app.user.id }})
                // On écoute les évènements provenant de mercure
                const eventSource = new EventSource(url)
                eventSource.onmessage = (e) => {
                    if(JSON.parse(e.data).topic === '/accueil/notifications/demande_ajout/' + {{ app.user.id }}){
                        let toast = $('.toast');
                        $('.toast-body').html(JSON.parse(e.data).notification)
                        toast.toast({ autohide: false })
                        toast.toast('show')
                    }
                }
                //-- Désinscription aux topics mercure
                window.addEventListener('beforeunload', function () {
                    if(eventSource != null){
                        eventSource.close()
                    }
                })
            {% endif %}
        });
    </script>
{% endblock %}
